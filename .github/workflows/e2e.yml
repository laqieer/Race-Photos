name: E2E Tests

on:
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types: [completed]

jobs:
  e2e:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - run: npx playwright test
      - name: Generate E2E report summary
        if: always()
        run: |
          if [ -f test-report/e2e/index.html ]; then
            echo "# E2E Test Report" > test-report/e2e/summary.md
            echo "" >> test-report/e2e/summary.md
            echo "| Metric | Value |" >> test-report/e2e/summary.md
            echo "|--------|-------|" >> test-report/e2e/summary.md
            # Extract results from last-run.json
            if [ -f test-report/e2e/last-run.json ]; then
              node -e "
              var fs = require('fs');
              var r = JSON.parse(fs.readFileSync('test-report/e2e/last-run.json','utf8'));
              var status = r.status === 'passed' ? '✅ PASSED' : '❌ FAILED';
              console.log('| Status | ' + status + ' |');
              console.log('| Duration | ' + (r.stats.duration / 1000).toFixed(2) + 's |');
              console.log('| Expected | ' + r.stats.expected + ' |');
              if (r.stats.unexpected) console.log('| Failed | ' + r.stats.unexpected + ' |');
              if (r.stats.flaky) console.log('| Flaky | ' + r.stats.flaky + ' |');
              " >> test-report/e2e/summary.md
            fi
            cat test-report/e2e/summary.md >> $GITHUB_STEP_SUMMARY
          fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report
          path: test-report/e2e/
          retention-days: 30
