name: E2E Tests

on:
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types: [completed]

jobs:
  e2e:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - run: npx playwright test
      - name: Generate E2E report summary
        if: always()
        run: |
          if [ -f test-report/e2e/results.json ]; then
            node -e "
            var fs = require('fs');
            var r = JSON.parse(fs.readFileSync('test-report/e2e/results.json','utf8'));
            var lines = ['# E2E Test Report\n'];
            lines.push('| Metric | Value |');
            lines.push('|--------|-------|');
            var passed = 0, failed = 0, flaky = 0, skipped = 0;
            r.suites.forEach(function walk(s) {
              (s.specs || []).forEach(function(spec) {
                spec.tests.forEach(function(t) {
                  if (t.status === 'expected') passed++;
                  else if (t.status === 'unexpected') failed++;
                  else if (t.status === 'flaky') flaky++;
                  else if (t.status === 'skipped') skipped++;
                });
              });
              (s.suites || []).forEach(walk);
            });
            var total = passed + failed + flaky + skipped;
            var status = failed === 0 ? '✅ PASSED' : '❌ FAILED';
            lines.push('| Status | ' + status + ' |');
            lines.push('| Passed | ' + passed + ' |');
            if (failed) lines.push('| Failed | ' + failed + ' |');
            if (flaky) lines.push('| Flaky | ' + flaky + ' |');
            if (skipped) lines.push('| Skipped | ' + skipped + ' |');
            lines.push('| Total | ' + total + ' |');
            var duration = (r.stats.duration / 1000).toFixed(2);
            lines.push('| Duration | ' + duration + 's |\n');
            r.suites.forEach(function walk(s) {
              if (s.title) lines.push('## ' + s.title);
              (s.specs || []).forEach(function(spec) {
                spec.tests.forEach(function(t) {
                  var icon = t.status === 'expected' ? '✅' : t.status === 'flaky' ? '⚠️' : '❌';
                  lines.push('- ' + icon + ' ' + spec.title);
                });
              });
              (s.suites || []).forEach(walk);
            });
            fs.writeFileSync('test-report/e2e/summary.md', lines.join('\n'));
            " 
            cat test-report/e2e/summary.md >> $GITHUB_STEP_SUMMARY
          fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report
          path: test-report/e2e/
          retention-days: 30
